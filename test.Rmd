```{r}
# NY STOCK for multiple regression
library(dplyr)
library(car)
prices = read.csv("prices.csv")
securities = read.csv("securities.csv")
fund = read.csv("fundamentals.csv")
psa = read.csv("prices-split-adjusted.csv")


# focus mainly on psa dataset because it accounts for price splits.
psa$difference = 0
difference = psa$difference
close = psa$close
open = psa$open

for(i in 1:nrow(psa))
{
  difference[i] = (close[i]/open[i])
  if(difference[i] > 1)
  {
    difference[i] = difference[i] - 1
  }
  else if(difference[i] < 1)
  {
    difference[i] = difference[i] - 1
  }
}

# stock return for a certain year


telecommunications = securities %>% 
  filter(GICS.Sector == "Telecommunications Services")


bind = psa %>% filter(psa$symbol == "T" |psa$symbol == "CTL" | psa$symbol =="FTR"| psa$symbol == "LVLT"| psa$symbol == "VZ")

difference = 0
bind = cbind(bind, difference)


for(i in 1:nrow(bind))
{
  bind$difference[i] = (bind$close[i]/bind$open[i])
  if(bind$difference[i] > 1)
  {
    bind$difference[i] = bind$difference[i] - 1
  }
  else if(bind$difference[i] < 1)
  {
    bind$difference[i] = bind$difference[i] - 1
  }
}


fundtemp = fund %>% 
  filter(Ticker.Symbol == "T" | Ticker.Symbol == "CTL"|Ticker.Symbol == "FTR" | Ticker.Symbol == "LVLT" | Ticker.Symbol == "VZ")



ctl = bind[bind$symbol == "CTL",]
atnt = bind[bind$symbol == "T",]
ftr = bind[bind$symbol == "FTR",]
vz = bind[bind$symbol == "VZ",]
lvlt = bind[bind$symbol == "LVLT",]

# TEST MODEL ADEQUACY

# residual analysis, test if errors are normally distributed

bindlm = lm(close ~ open  + difference + open*difference, data = bind)
summary(bindlm)
vif(bindlm)

bindlm = lm(close ~ open + low*high + volume, data = bind)
vif(bindlm)

bindlm = lm(close ~ open + low + high + volume, data = bind)
vif(bindlm)

plot(bindlm)

plot(bindlm, which = 1)
# We see that the residuals are randomly scattered about 0, but there seems to be a notable gap between roughly 8-12. Point 426, 2218, and 7100 may be outliers. 


plot(bindlm, which = 2)
# Normal QQ plot large gap point 2218 and 426, and a smaller gap point 7100. Most points lies along the line across 0. Data is normally distributed



plot(bindlm, which = 3)
# The red line is approximately horizontal, which means that the average magnitude of standardized residuals is not changing as a function of the fitted values. Spread is also about even across the red line but there is another notable gap between roughly 10 and 13. Since there are a lot of points, 426, 2218, and 7100 does not affect the plot and red line greatly.


plot(bindlm, which = 5)
# Point 2218 and 426 falls outside the dotted line meaning that they are high influence points.


# Now let's test for each diff models

ctllm = lm(close ~ open + low + high, data = ctl)
plot(ctllm)
summary(ctllm)

ftrlm = lm(close ~ open + low + high, data = ftr)
plot(ftrlm)
summary(ftrlm)

lvltlm = lm(close ~ open + low + high, data = lvlt)
plot(lvltlm)
summary(lvltlm)

atntlm = lm(close ~ open + low + high, data = atnt)
plot(atntlm)
summary(atntlm)

vzlm = lm(close ~ open + low + high, data = vz)
plot(vzlm)
summary(vzlm)

# Now we can make prediction based off of time. I will be using data from 2012-2015 to try to predict the year 2016

# CTL first, we will take dates from jan 01 2010 - dec 31 2014 to form the test data
date = as.Date(ctl[,1])
newctl = cbind(date,ctl)
newctl = subset(newctl, select = -c(2))

trainctl = newctl %>% 
  filter(date < "2014-12-31")


testctl = newctl %>% 
  filter(date > "2015-01-01")

# fitting data using training data
trainctllm = lm(close ~ open + low + high, data = trainctl)
summary(trainctllm)
vif(trainctllm)

# coefficients are similar to ones before, same variables are significant
preds = predict(trainctllm, testctl)

plot(preds)


plot(testctl$close,preds)
abline(c(0,1))

```

